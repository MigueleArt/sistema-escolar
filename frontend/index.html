<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gestión Escolar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .view { display: none; }
        .view.active { display: block; }
        .nav-link { transition: all 0.2s ease-in-out; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6; /* blue-500 */
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <!-- Vista de Inicio de Sesión -->
    <div id="login-view" class="view active">
        <div class="min-h-screen flex items-center justify-center bg-gray-50 py-12 px-4 sm:px-6 lg:px-8">
            <div class="max-w-md w-full space-y-8">
                <div>
                    <i class="fas fa-university mx-auto h-12 w-auto text-5xl text-green-700"></i>
                    <h2 class="mt-6 text-center text-3xl font-extrabold text-gray-900">
                        Sistema de Gestión Escolar
                    </h2>
                </div>
                <form id="login-form" class="mt-8 space-y-6">
                    <div class="rounded-md shadow-sm -space-y-px">
                        <div>
                            <label for="matricula" class="sr-only">Matrícula</label>
                            <input id="matricula" name="matricula" type="text" required class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-t-md focus:outline-none focus:ring-green-500 focus:border-green-500 focus:z-10 sm:text-sm" placeholder="Matrícula (ej. 12345)" value="12345">
                        </div>
                        <div>
                            <label for="password" class="sr-only">Contraseña</label>
                            <input id="password" name="password" type="password" autocomplete="current-password" required class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-b-md focus:outline-none focus:ring-green-500 focus:border-green-500 focus:z-10 sm:text-sm" placeholder="Contraseña" value="password123">
                        </div>
                    </div>
                    <div>
                        <button type="submit" class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-green-700 hover:bg-green-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                            <span class="absolute left-0 inset-y-0 flex items-center pl-3">
                                <i class="fas fa-lock h-5 w-5 text-green-600 group-hover:text-green-400"></i>
                            </span>
                            Ingresar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Vista Principal de la Aplicación -->
    <div id="app-view" class="view">
        <div class="flex h-screen bg-gray-200">
            <!-- Barra Lateral -->
            <div class="hidden md:flex flex-col w-64 bg-gray-800">
                <div class="flex items-center justify-center h-16 bg-gray-900">
                    <i class="fas fa-university text-white text-2xl mr-2"></i>
                    <span class="text-white font-bold uppercase">UTT</span>
                </div>
                <div class="flex flex-col flex-1 overflow-y-auto">
                    <nav class="flex-1 px-2 py-4 bg-gray-800">
                        <a href="#dashboard" class="nav-link flex items-center px-4 py-2 text-gray-100 bg-green-700 rounded-md">
                            <i class="fas fa-tachometer-alt mr-2"></i> Dashboard
                        </a>
                        <a href="#perfil" class="nav-link flex items-center px-4 py-2 mt-2 text-gray-400 hover:bg-gray-700 hover:text-gray-100 rounded-md">
                            <i class="fas fa-user mr-2"></i> Mi Perfil
                        </a>
                        <a href="#inscripciones" class="nav-link flex items-center px-4 py-2 mt-2 text-gray-400 hover:bg-gray-700 hover:text-gray-100 rounded-md">
                            <i class="fas fa-edit mr-2"></i> Inscripciones
                        </a>
                        <a href="#pagos" class="nav-link flex items-center px-4 py-2 mt-2 text-gray-400 hover:bg-gray-700 hover:text-gray-100 rounded-md">
                            <i class="fas fa-dollar-sign mr-2"></i> Pagos
                        </a>
                    </nav>
                </div>
            </div>

            <!-- Contenido Principal -->
            <div class="flex flex-col flex-1 overflow-y-auto">
                <div class="p-4 md:p-8">
                    <div id="dashboard-content" class="app-content"></div>
                    <div id="perfil-content" class="app-content"></div>
                    <div id="inscripciones-content" class="app-content"></div>
                    <div id="pagos-content" class="app-content"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Genérico -->
    <div id="modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <div id="modal-icon" class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-blue-100">
                </div>
                <h3 id="modal-title" class="text-lg leading-6 font-medium text-gray-900 mt-2"></h3>
                <div class="mt-2 px-7 py-3">
                    <p id="modal-body" class="text-sm text-gray-500"></p>
                </div>
                <div id="modal-loader-container" class="hidden justify-center items-center py-3">
                    <div class="loader"></div>
                    <p class="ml-3 text-gray-600">Procesando...</p>
                </div>
                <div id="modal-footer" class="items-center px-4 py-3">
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- ESTADO DE LA APLICACIÓN ---
        const AppState = { currentUser: null, materias: [], inscripciones: [], pagos: [] };
        
        // --- URL DEL GATEWAY EN RENDER ---
        const API_BASE_URL = 'https://api-gateway-bimt.onrender.com/api';

        // --- LÓGICA DE API ---
        const api = {
            login: (matricula, password) => {
                return new Promise((resolve, reject) => {
                    setTimeout(() => {
                        if (matricula === '12345' && password === 'password123') {
                            resolve({
                                nombre: 'Miguel Alumno',
                                matricula: '12345',
                                email: 'miguel.alumno@universidad.edu',
                                carrera: 'Ingeniería en Desarrollo de Software',
                                cuatrimestre: '7mo',
                                grupo: 'A'
                            });
                        } else {
                            reject('Credenciales inválidas');
                        }
                    }, 1000);
                });
            },
            getMaterias: async () => {
                const response = await fetch(`${API_BASE_URL}/inscripciones/materias`);
                if (!response.ok) throw new Error('Error al cargar las materias');
                const materias = await response.json();
                AppState.materias = materias;
                return materias;
            },
            inscribirMateria: async (materiaId) => {
                const response = await fetch(`${API_BASE_URL}/inscripciones`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ materiaId })
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.error || 'Error al inscribir materia');
                AppState.inscripciones.push({ materiaId, status: 'PENDIENTE_PAGO' });
                return result;
            },
            realizarPago: async (inscripcion) => {
                const response = await fetch(`${API_BASE_URL}/pagos`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ inscripcionId: inscripcion.materiaId })
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.error || 'Error al procesar el pago');
                
                const inscripcionIndex = AppState.inscripciones.findIndex(i => i.materiaId === inscripcion.materiaId);
                if (inscripcionIndex !== -1) {
                  AppState.inscripciones[inscripcionIndex].status = 'INSCRITO';
                }
                
                const materia = AppState.materias.find(m => m.id === inscripcion.materiaId);
                if (materia) materia.inscritos++;
                
                return result;
            }
        };

        // --- MANEJO DE VISTAS Y NAVEGACIÓN ---
        const loginView = document.getElementById('login-view');
        const appView = document.getElementById('app-view');
        
        function showView(viewId) {
            loginView.classList.remove('active');
            appView.classList.remove('active');
            document.getElementById(viewId).classList.add('active');
        }

        function navigate(hash) {
            if (!hash) hash = '#dashboard';
            
            document.querySelectorAll('.app-content').forEach(c => c.style.display = 'none');
            document.querySelectorAll('.nav-link').forEach(l => {
                l.classList.remove('bg-green-700', 'text-gray-100');
                l.classList.add('text-gray-400');
            });

            const contentId = `${hash.substring(1)}-content`;
            const activeContent = document.getElementById(contentId);
            const activeLink = document.querySelector(`.nav-link[href="${hash}"]`);

            if (activeContent) {
                activeContent.style.display = 'block';
                if (activeLink) {
                    activeLink.classList.remove('text-gray-400');
                    activeLink.classList.add('bg-green-700', 'text-gray-100');
                }
                
                switch(hash) {
                    case '#dashboard': renderDashboard(); break;
                    case '#perfil': renderPerfil(); break;
                    case '#inscripciones': renderInscripciones(); break;
                    case '#pagos': renderPagos(); break;
                }
            }
        }

        // --- LÓGICA DE MODALES ---
        const modal = document.getElementById('modal');
        function openModal(title, body, iconHtml, footerHtml) {
            modal.querySelector('#modal-title').textContent = title;
            modal.querySelector('#modal-body').innerHTML = body;
            modal.querySelector('#modal-icon').innerHTML = iconHtml;
            modal.querySelector('#modal-footer').innerHTML = footerHtml;
            modal.querySelector('#modal-loader-container').classList.add('hidden');
            modal.classList.remove('hidden');
        }
        function closeModal() { modal.classList.add('hidden'); }
        function showModalLoader() {
            modal.querySelector('#modal-footer').innerHTML = '';
            modal.querySelector('#modal-loader-container').classList.remove('hidden');
        }
        function updateModal(title, body, iconHtml, footerHtml) {
            openModal(title, body, iconHtml, footerHtml);
        }

        // --- RENDERIZADO DE CONTENIDO (COMPLETO) ---
        function renderDashboard() {
            const inscritas = AppState.inscripciones.filter(i => i.status === 'INSCRITO').length;
            const materiasInscritas = AppState.inscripciones
                .filter(i => i.status === 'INSCRITO')
                .map(inscripcion => AppState.materias.find(m => m.id === inscripcion.materiaId));

            let materiasHtml = materiasInscritas.length > 0 ? materiasInscritas.map(m => `
                <div class="border-t border-gray-200 p-4 flex justify-between items-center">
                    <div><p class="font-semibold text-gray-800">${m.nombre}</p><p class="text-sm text-gray-500">${m.profesor || 'Profesor Asignado'}</p></div>
                    <span class="text-sm font-medium text-green-600 bg-green-100 py-1 px-3 rounded-full">Inscrito</span>
                </div>`).join('') : '<p class="p-4 text-gray-500 text-center">Aún no tienes materias inscritas.</p>';

            document.getElementById('dashboard-content').innerHTML = `
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Bienvenido, ${AppState.currentUser.nombre}</h1>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <div class="bg-white rounded-lg shadow p-6 flex items-center"><i class="fas fa-book text-3xl text-green-600 mr-4"></i><div><p class="text-sm text-gray-500">Materias Inscritas</p><p class="text-2xl font-bold text-gray-900">${inscritas}</p></div></div>
                    <div class="bg-white rounded-lg shadow p-6 flex items-center"><i class="fas fa-calendar-alt text-3xl text-green-600 mr-4"></i><div><p class="text-sm text-gray-500">Próximo Periodo</p><p class="text-xl font-bold text-gray-900">Sep - Dic 2025</p></div></div>
                </div>
                <div class="bg-white rounded-lg shadow"><div class="p-6 border-b border-gray-200"><h2 class="text-xl font-bold text-gray-800">Mis Materias Inscritas</h2></div><div>${materiasHtml}</div></div>`;
        }
        
        function renderPerfil() {
            const user = AppState.currentUser;
            document.getElementById('perfil-content').innerHTML = `
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Mi Perfil</h1>
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div><p class="text-sm text-gray-500">Nombre Completo</p><p class="font-semibold text-gray-900">${user.nombre}</p></div>
                        <div><p class="text-sm text-gray-500">Matrícula</p><p class="font-semibold text-gray-900">${user.matricula}</p></div>
                        <div><p class="text-sm text-gray-500">Correo Electrónico</p><p class="font-semibold text-gray-900">${user.email}</p></div>
                        <div><p class="text-sm text-gray-500">Carrera</p><p class="font-semibold text-gray-900">${user.carrera}</p></div>
                        <div><p class="text-sm text-gray-500">Cuatrimestre</p><p class="font-semibold text-gray-900">${user.cuatrimestre}</p></div>
                        <div><p class="text-sm text-gray-500">Grupo</p><p class="font-semibold text-gray-900">${user.grupo}</p></div>
                    </div>
                </div>`;
        }

        function renderInscripciones() {
            let materiasHtml = AppState.materias.map(materia => {
                const yaInscrito = AppState.inscripciones.some(i => i.materiaId === materia.id && i.status === 'INSCRITO');
                const pendientePago = AppState.inscripciones.some(i => i.materiaId === materia.id && i.status === 'PENDIENTE_PAGO');
                const cupoDisponible = materia.inscritos < materia.cupo;
                
                let buttonHtml;
                if (yaInscrito) buttonHtml = `<button disabled class="px-4 py-2 text-sm font-medium text-white bg-green-500 rounded-md cursor-not-allowed">Inscrito</button>`;
                else if (pendientePago) buttonHtml = `<a href="#pagos" class="px-4 py-2 text-sm font-medium text-white bg-yellow-500 hover:bg-yellow-600 rounded-md">Pago Pendiente</a>`;
                else if (!cupoDisponible) buttonHtml = `<button disabled class="px-4 py-2 text-sm font-medium text-white bg-gray-400 rounded-md cursor-not-allowed">Sin Cupo</button>`;
                else buttonHtml = `<button data-materia-id="${materia.id}" class="inscribir-btn px-4 py-2 text-sm font-medium text-white bg-green-700 hover:bg-green-800 rounded-md">Inscribir</button>`;

                return `<tr class="border-b">
                    <td class="p-4 text-gray-800">${materia.nombre}</td>
                    <td class="p-4 text-gray-600">${materia.profesor || 'Por Asignar'}</td>
                    <td class="p-4 text-gray-600">${materia.inscritos} / ${materia.cupo}</td>
                    <td class="p-4 text-right">${buttonHtml}</td>
                </tr>`;
            }).join('');

            document.getElementById('inscripciones-content').innerHTML = `
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Oferta de Materias</h1>
                <div class="bg-white rounded-lg shadow overflow-hidden">
                    <table class="min-w-full">
                        <thead class="bg-gray-50"><tr>
                            <th class="p-4 text-left text-xs font-medium text-gray-500 uppercase">Materia</th>
                            <th class="p-4 text-left text-xs font-medium text-gray-500 uppercase">Profesor</th>
                            <th class="p-4 text-left text-xs font-medium text-gray-500 uppercase">Cupo</th>
                            <th class="p-4 text-right"></th>
                        </tr></thead>
                        <tbody>${materiasHtml}</tbody>
                    </table>
                </div>`;
        }

        function renderPagos() {
            const pagosPendientes = AppState.inscripciones.filter(i => i.status === 'PENDIENTE_PAGO');
            let pagosHtml;
            if (pagosPendientes.length > 0) {
                pagosHtml = pagosPendientes.map(inscripcion => {
                    const materia = AppState.materias.find(m => m.id === inscripcion.materiaId);
                    return `<div class="bg-white rounded-lg shadow p-6 flex justify-between items-center mb-4">
                        <div>
                            <h3 class="font-bold text-lg text-gray-800">Inscripción a: ${materia.nombre}</h3>
                            <p class="text-sm text-gray-500">Concepto: Colegiatura e Inscripción Cuatrimestral</p>
                            <p class="text-2xl font-bold text-green-700 mt-2">$5,500.00 MXN</p>
                        </div>
                        <button data-inscripcion-id="${materia.id}" class="pagar-btn bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-lg transition duration-300">Proceder al Pago</button>
                    </div>`;
                }).join('');
            } else {
                pagosHtml = `<div class="bg-white rounded-lg shadow p-6 text-center"><p class="text-gray-500">No tienes pagos pendientes.</p></div>`;
            }

            document.getElementById('pagos-content').innerHTML = `
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Mis Pagos</h1>
                ${pagosHtml}`;
        }

        // --- MANEJADORES DE EVENTOS ---
        async function handleLogin(e) {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = `<div class="loader mx-auto"></div>`;

            try {
                const matricula = document.getElementById('matricula').value;
                const password = document.getElementById('password').value;
                const user = await api.login(matricula, password);
                AppState.currentUser = user;
                
                await api.getMaterias();
                
                showView('app-view');
                navigate(window.location.hash || '#dashboard');
            } catch (error) {
                alert(error);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }
        
        async function handleInscribirClick(materiaId) {
            const materia = AppState.materias.find(m => m.id === materiaId);
            openModal('Confirmar Inscripción', `¿Deseas inscribirte a la materia "${materia.nombre}"? Esto generará una orden de pago.`, '<i class="fas fa-question-circle text-4xl text-blue-500"></i>',
                `<button id="cancel-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300 mr-2">Cancelar</button><button id="confirm-btn" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">Confirmar</button>`);
            document.getElementById('cancel-btn').onclick = closeModal;
            document.getElementById('confirm-btn').onclick = async () => {
                showModalLoader();
                try {
                    await api.inscribirMateria(materiaId);
                    updateModal('Orden Generada', 'Se ha creado tu orden de pago. Ve a la sección de Pagos para completarla.', '<i class="fas fa-check-circle text-4xl text-green-500"></i>', `<button id="ok-btn" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">Aceptar</button>`);
                    document.getElementById('ok-btn').onclick = () => { closeModal(); renderInscripciones(); };
                } catch (error) {
                    updateModal('Error', `No se pudo generar la orden: ${error.message}`, '<i class="fas fa-times-circle text-4xl text-red-500"></i>', `<button id="ok-btn" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">Cerrar</button>`);
                    document.getElementById('ok-btn').onclick = closeModal;
                }
            };
        }

        async function handlePagarClick(inscripcionId) {
            const inscripcion = AppState.inscripciones.find(i => i.materiaId === inscripcionId);
            const materia = AppState.materias.find(m => m.id === inscripcionId);

            openModal('Procesando Pago', `Simulando conexión segura con la pasarela de pagos para la inscripción a "${materia.nombre}".`, '<i class="fas fa-credit-card text-4xl text-green-600"></i>', '');
            showModalLoader();

            try {
                const result = await api.realizarPago(inscripcion);
                const blob = new Blob([`Comprobante de Pago: ${result.comprobanteId}\nMateria: ${materia.nombre}\nMonto: $5,500.00 MXN`], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);

                updateModal('¡Pago Exitoso!', 'Tu inscripción ha sido confirmada. Puedes descargar tu comprobante.', '<i class="fas fa-check-circle text-4xl text-green-500"></i>',
                    `<a href="${url}" download="comprobante-${result.comprobanteId}.txt" id="download-btn" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 mr-2">Descargar Comprobante</a><button id="close-modal-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300">Finalizar</button>`);
                document.getElementById('close-modal-btn').onclick = () => { closeModal(); renderPagos(); navigate('#dashboard'); };
            } catch (error) {
                 updateModal('Error en el Pago', error.message, '<i class="fas fa-times-circle text-4xl text-red-500"></i>', `<button id="ok-btn" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">Cerrar</button>`);
                 document.getElementById('ok-btn').onclick = closeModal;
            }
        }

        // --- LÓGICA DE INICIO ---
        function initApp() {
            const loginForm = document.getElementById('login-form');
            if (loginForm) {
                loginForm.addEventListener('submit', handleLogin);
            }
            window.addEventListener('hashchange', () => navigate(window.location.hash));
            
            // Event Delegation para botones dinámicos
            document.body.addEventListener('click', function(e) {
                if (e.target.classList.contains('inscribir-btn')) {
                    handleInscribirClick(e.target.dataset.materiaId);
                }
                if (e.target.classList.contains('pagar-btn')) {
                    handlePagarClick(e.target.dataset.inscripcionId);
                }
            });

            showView('login-view');
        }

        // --- EVENTO DE INICIO ---
        window.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>

